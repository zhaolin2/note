## synchronized锁

### 偏向锁

加锁：

1. 访问markword 看当前对象的是否是偏向锁

2. 如果是偏向锁 那么测试当前线程ID是否指向当前线程，是的话进入5，否则进入3

3. 没有指向当前线程，那么通过cas来竞争操作锁(把mark word的线程ID设置为当前线程ID，成功的话，执行5，否则执行4

4. 如果cas获取偏向锁失败，表示有竞争，当到达全局安全点的时候，获取偏向锁的线程被挂起，进行锁升级，然后被阻塞在安全点的线程继续执行

5. 执行同步代码块

释放锁：

1. 新来的线程尝试cas操作，成功则获得偏向锁
2. 失败，那么等待持有的线程达到安全点
3. 暂停持有偏向锁的线程，如果已经退出，或者未活动，就把对象头设置为无锁状态
4. 如果没有退出 则升级到轻量级锁

安全点：

- 循环的末尾

- 方法临返回前

- 调用方法之后

- 抛异常的位置

### 轻量级锁

加锁过程：

1. 分配空间并复制mark word到栈，尝试使用cas获取锁，成功的话，会把对象头的markword替换为指向所记录的指针，失败进行自旋
2. 执行完开始解锁

解锁：

cas把栈中的 displaced mark word 替换会对象头，成功表示无竞争，失败则表示有锁竞争，

 <img src="https://pic1.zhimg.com/v2-9db4211af1be81785f6cc51a58ae6054_r.jpg" alt="preview" style="zoom:200%;" /> 

 

